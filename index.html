<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Paked Launcher</title>
<style>
  body, html {margin:0;padding:0;font-family:Arial,sans-serif;background:#1e1e2f;color:white;height:100%;}
  .top-bar {background:#2c2c3c;padding:10px 20px;display:flex;align-items:center;height:50px;z-index:3;position:relative;}
  .top-bar h1 {margin:0;font-size:18px;}
  .side-panel {position:absolute;top:50px;left:0;width:60px;height:calc(100% - 50px);background:#2a2a3a;transition:width .3s ease;overflow-y:auto;overflow-x:hidden;z-index:3;}
  .side-panel.expanded {width:300px;}
  .side-panel button.toggle-btn {background:transparent;border:none;color:white;width:100%;padding:15px;text-align:left;cursor:pointer;font-size:16px;}
  .panel-section {margin-top:10px;padding:0 10px;}
  .panel-section.hidden {display:none;}
  .panel-section h2 {font-size:16px;border-bottom:1px solid #444;padding-bottom:5px;margin-bottom:8px;}
  .build-item {display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:5px;background:#3a3a4a;border-radius:5px;font-size:16px;user-select:none;}
  .build-item.downloadable {cursor:pointer;color:#76c7c0;}
  .build-item.downloadable:hover {background:#4a4a5a;}
  .build-item.downloaded {opacity:.5;cursor:default;color:#aaa;}
  .build-actions {display:flex;gap:5px;}
  .build-actions button {background:#555;border:none;color:white;padding:5px 10px;border-radius:3px;cursor:pointer;font-size:14px;}
  .download-icon {margin-right:8px;font-weight:bold;color:#76c7c0;user-select:none;}
  .divider {height:1px;background:#444;margin:10px 0;}
  .divider.hidden {display:none;}
  .content {margin-left:60px;margin-top:50px;padding:20px;transition:margin-left .3s ease;position:relative;z-index:2;}
  .side-panel.expanded ~ .content {margin-left:300px;}
  .play-section {text-align:center;margin-top:100px;}
  .play-button {padding:20px 50px;font-size:24px;background:#28a745;border:none;border-radius:5px;color:white;cursor:pointer;}
  .progress-bar {margin-top:20px;width:300px;height:20px;background:#444;border-radius:10px;overflow:hidden;display:none;margin-left:auto;margin-right:auto;}
  .progress-fill {height:100%;background:#76c7c0;width:0%;transition:width .2s ease-in-out;}
  .iframe-overlay {position:fixed;top:0;left:0;width:100vw;height:100vh;background:black;z-index:9999;opacity:0;transition:opacity .5s ease;pointer-events:none;}
  .iframe-overlay.visible {opacity:1;pointer-events:all;}
  .iframe-overlay iframe {width:100%;height:100%;border:none;}
</style>
</head>
<body>

<div class="top-bar"><h1>Paked Launcher</h1></div>

<div id="sidePanel" class="side-panel">
  <button class="toggle-btn" onclick="toggleSidePanel()">☰</button>
  <div id="localBuildsSection" class="panel-section hidden">
    <h2>Downloaded Builds</h2><div id="localBuilds"></div>
  </div>
  <div id="divider" class="divider hidden"></div>
  <div id="downloadableBuildsSection" class="panel-section hidden">
    <h2>Downloadable Builds</h2><div id="downloadableBuilds"></div>
  </div>
</div>

<div class="content">
  <div class="play-section">
    <button class="play-button" onclick="playLatestBuild()">Play Latest Build</button>
    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>
</div>

<div id="iframeContainer" class="iframe-overlay">
  <iframe id="gameIframe"></iframe>
</div>

<script>
const WORKER_URL = "https://paked.proliverplays.workers.dev/";
let db, sidePanelExpanded=false, currentDownloadableBuilds=[];

// IndexedDB
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open("PakedLauncher",1);
    r.onupgradeneeded=e=>{
      db=e.target.result;
      if(!db.objectStoreNames.contains("builds"))
        db.createObjectStore("builds");
    };
    r.onsuccess=e=>{db=e.target.result;res();};
    r.onerror=e=>rej(e);
  });
}

function saveBuild(v,h){
  return new Promise((res,rej)=>{
    const tx=db.transaction("builds","readwrite");
    tx.objectStore("builds").put(h,v);
    tx.oncomplete=res;
    tx.onerror=e=>rej(e);
  });
}

function getBuild(v){
  return new Promise((res,rej)=>{
    const tx=db.transaction("builds","readonly");
    const req=tx.objectStore("builds").get(v);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

function saveBuildList(b){
  localStorage.setItem("pakedBuilds",JSON.stringify(b));
}
function getBuildList(){
  return JSON.parse(localStorage.getItem("pakedBuilds"))||[];
}
function cleanVersionName(n){
  return n.replace(/\.html$/i,"").trim();
}

/* ✅ FIXED VERSION SORTING */
function parseVersion(version){
  return version
    .replace(/\.html$/i,"")
    .match(/\d+/g)
    ?.map(Number) || [0];
}

function compareVersionsDesc(a,b){
  const va=parseVersion(a);
  const vb=parseVersion(b);
  const len=Math.max(va.length,vb.length);
  for(let i=0;i<len;i++){
    const diff=(vb[i]||0)-(va[i]||0);
    if(diff!==0) return diff;
  }
  return 0;
}

// UI
function toggleSidePanel(){
  sidePanelExpanded=!sidePanelExpanded;
  const p=sidePanel, l=localBuildsSection, d=downloadableBuildsSection, div=divider;
  if(sidePanelExpanded){
    p.classList.add("expanded");
    l.classList.toggle("hidden",getBuildList().length===0);
    d.classList.toggle("hidden",currentDownloadableBuilds.length===0);
    div.classList.toggle("hidden",!(getBuildList().length&&currentDownloadableBuilds.length));
  }else{
    p.classList.remove("expanded");
    l.classList.add("hidden");
    d.classList.add("hidden");
    div.classList.add("hidden");
  }
}

function loadLocalBuilds(){
  const builds=getBuildList().sort(compareVersionsDesc);
  localBuilds.innerHTML="";
  builds.forEach(v=>{
    const item=document.createElement("div");
    item.className="build-item";
    item.textContent=cleanVersionName(v);
    const actions=document.createElement("div");
    actions.className="build-actions";
    const play=document.createElement("button");
    play.textContent="Play";
    play.onclick=()=>playLocalBuild(v);
    actions.append(play);
    item.append(actions);
    localBuilds.append(item);
  });
}

async function fetchAvailableBuilds(){
  const res=await fetch(WORKER_URL+"list");
  const builds=await res.json();
  currentDownloadableBuilds=builds.sort(compareVersionsDesc);
  downloadableBuilds.innerHTML="";
  currentDownloadableBuilds.forEach(v=>{
    const item=document.createElement("div");
    item.className="build-item downloadable";
    item.textContent=cleanVersionName(v);
    item.onclick=()=>playBuild(v);
    downloadableBuilds.append(item);
  });
}

async function playLocalBuild(v){
  const html=await getBuild(v);
  gameIframe.srcdoc=html;
  iframeContainer.classList.add("visible");
}

function playBuild(v){
  if(getBuildList().includes(v)) playLocalBuild(v);
}

function playLatestBuild(){
  if(currentDownloadableBuilds.length)
    playBuild(currentDownloadableBuilds[0]);
  else{
    const local=getBuildList().sort(compareVersionsDesc);
    if(local.length) playLocalBuild(local[0]);
    else alert("No builds available");
  }
}

window.onload=async()=>{
  await openDB();
  loadLocalBuilds();
  fetchAvailableBuilds();
};
</script>
</body>
</html>
