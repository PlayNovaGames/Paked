<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Paked Launcher</title>
<style>
  body, html {margin: 0; padding: 0; font-family: Arial, sans-serif; background: #1e1e2f; color: white; height: 100%;}
  .top-bar {background: #2c2c3c; padding: 10px 20px; display: flex; align-items: center; height: 50px; z-index: 3; position: relative;}
  .top-bar h1 {margin: 0; font-size: 18px;}
  .side-panel {position: absolute; top: 50px; left: 0; width: 60px; height: calc(100% - 50px); background: #2a2a3a; transition: width 0.3s ease; overflow-y: auto; overflow-x: hidden; z-index: 3;}
  .side-panel.expanded {width: 300px;}
  .side-panel button.toggle-btn {background: transparent; border: none; color: white; width: 100%; padding: 15px; text-align: left; cursor: pointer; font-size: 16px;}
  .panel-section {margin-top: 10px; padding: 0 10px;}
  .panel-section.hidden {display: none;}
  .panel-section h2 {font-size: 16px; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 8px;}
  .build-item {display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 5px; background: #3a3a4a; border-radius: 5px; font-size: 16px; user-select: none;}
  .build-item.downloadable {cursor: pointer; color: #76c7c0;}
  .build-item.downloadable:hover {background: #4a4a5a;}
  .build-item.downloaded {opacity: 0.5; cursor: default; color: #aaa;}
  .build-actions {display: flex; gap: 5px;}
  .build-actions button {background: #555; border: none; color: white; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 14px;}
  .download-icon {margin-right: 8px; font-weight: bold; color: #76c7c0; user-select: none;}
  .divider {height: 1px; background: #444; margin: 10px 0;}
  .divider.hidden {display: none;}
  .content {margin-left: 60px; margin-top: 50px; padding: 20px; transition: margin-left 0.3s ease; position: relative; z-index: 2;}
  .side-panel.expanded ~ .content {margin-left: 300px;}
  .play-section {text-align: center; margin-top: 100px;}
  .play-button {padding: 20px 50px; font-size: 24px; background: #28a745; border: none; border-radius: 5px; color: white; cursor: pointer;}
  .progress-bar {margin-top: 20px; width: 300px; height: 20px; background: #444; border-radius: 10px; overflow: hidden; display: none; margin-left: auto; margin-right: auto;}
  .progress-fill {height: 100%; background: #76c7c0; width: 0%; transition: width 0.2s ease-in-out;}
  .iframe-overlay {position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: black; z-index: 9999; opacity: 0; transition: opacity 0.5s ease; pointer-events: none;}
  .iframe-overlay.visible {opacity: 1; pointer-events: all;}
  .iframe-overlay iframe {width: 100%; height: 100%; border: none;}
</style>
</head>
<body>
<div class="top-bar">
  <h1>Paked Launcher</h1>
</div>

<div id="sidePanel" class="side-panel">
  <button class="toggle-btn" onclick="toggleSidePanel()">☰</button>
  <div id="localBuildsSection" class="panel-section hidden">
    <h2>Downloaded Builds</h2>
    <div id="localBuilds"></div>
  </div>
  <div id="divider" class="divider hidden"></div>
  <div id="downloadableBuildsSection" class="panel-section hidden">
    <h2>Downloadable Builds</h2>
    <div id="downloadableBuilds"></div>
  </div>
</div>

<div class="content">
  <div class="play-section">
    <button class="play-button" onclick="playLatestBuild()">Play Latest Build</button>
    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>
</div>

<div id="iframeContainer" class="iframe-overlay">
  <iframe id="gameIframe"></iframe>
</div>

<script>
const WORKER_URL = "https://paked.proliverplays.workers.dev/";
let sidePanelExpanded = false;
let currentDownloadableBuilds = [];
let db;

// --- IndexedDB ---
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("PakedLauncher", 1);
    request.onupgradeneeded = e => {
      db = e.target.result;
      if(!db.objectStoreNames.contains("builds")) db.createObjectStore("builds");
    };
    request.onsuccess = e => { db = e.target.result; resolve(); };
    request.onerror = e => reject(e);
  });
}

function saveBuild(version, html) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("builds", "readwrite");
    const store = tx.objectStore("builds");
    store.put(html, version);
    tx.oncomplete = () => resolve();
    tx.onerror = e => reject(e);
  });
}

function getBuild(version) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("builds", "readonly");
    const store = tx.objectStore("builds");
    const request = store.get(version);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function deleteBuild(version) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("builds", "readwrite");
    const store = tx.objectStore("builds");
    store.delete(version);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

// --- Local build tracking ---
function saveBuildList(builds) { localStorage.setItem("pakedBuilds", JSON.stringify(builds)); }
function getBuildList() { return JSON.parse(localStorage.getItem("pakedBuilds"))||[]; }
function cleanVersionName(name){ return name.replace(/\.html$/i,"").trim(); }
function hasLocalBuilds(){ return getBuildList().length>0; }
function hasDownloadableBuilds(){ return currentDownloadableBuilds.length>0; }

// --- Compare versions (newest first) ---
function compareVersions(a, b) {
  const pa = a.trim().replace(/^v/i, '').split('.').map(n => parseInt(n, 10));
  const pb = b.trim().replace(/^v/i, '').split('.').map(n => parseInt(n, 10));
  const maxLen = Math.max(pa.length, pb.length);
  for (let i = 0; i < maxLen; i++) {
    const na = pa[i] || 0;
    const nb = pb[i] || 0;
    if (na > nb) return -1;
    if (na < nb) return 1;
  }
  return 0;
}

function sortBuilds(builds){ return builds.slice().sort(compareVersions); }

// --- Load local builds ---
function loadLocalBuilds(){
  let builds = sortBuilds(getBuildList());
  const div = document.getElementById("localBuilds"); div.innerHTML="";
  if(builds.length===0){
    div.innerHTML="<div style='padding:10px;color:#888;'>No downloaded builds yet.</div>";
    checkDividerVisibility(); return;
  }
  builds.forEach(v=>{
    const item=document.createElement("div");
    item.className="build-item local";
    item.textContent=cleanVersionName(v);
    const actions=document.createElement("div"); actions.className="build-actions";
    const playBtn=document.createElement("button"); playBtn.textContent="Play"; playBtn.onclick=()=>playLocalBuild(v);
    const delBtn=document.createElement("button"); delBtn.textContent="Delete"; delBtn.onclick=async ()=>{
      if(confirm(`Delete build "${cleanVersionName(v)}"?`)){
        let buildList = getBuildList().filter(b=>b!==v);
        saveBuildList(buildList);
        await deleteBuild(v);
        loadLocalBuilds(); fetchAvailableBuilds();
      }
    };
    actions.append(playBtn, delBtn);
    item.appendChild(actions);
    div.appendChild(item);
  });
}

// --- Side panel ---
function toggleSidePanel() {
  sidePanelExpanded = !sidePanelExpanded;
  const panel = document.getElementById("sidePanel");
  const localSection = document.getElementById("localBuildsSection");
  const downloadableSection = document.getElementById("downloadableBuildsSection");
  const divider = document.getElementById("divider");
  if(sidePanelExpanded){
    panel.classList.add("expanded");
    localSection.classList.toggle("hidden", !hasLocalBuilds());
    downloadableSection.classList.toggle("hidden", !hasDownloadableBuilds());
    divider.classList.toggle("hidden", !(hasLocalBuilds() && hasDownloadableBuilds()));
  } else {
    panel.classList.remove("expanded");
    localSection.classList.add("hidden");
    downloadableSection.classList.add("hidden");
    divider.classList.add("hidden");
  }
}

function checkDividerVisibility(){
  const divider=document.getElementById("divider");
  const localVisible=!document.getElementById("localBuildsSection").classList.contains("hidden");
  const downloadVisible=!document.getElementById("downloadableBuildsSection").classList.contains("hidden");
  divider.classList.toggle("hidden", !(localVisible && downloadVisible));
}

// --- Fetch downloadable builds ---
async function fetchAvailableBuilds(){
  const div = document.getElementById("downloadableBuilds");
  div.innerHTML="";
  try{
    const res = await fetch(WORKER_URL+"list");
    if(!res.ok) throw new Error("Failed to fetch builds");
    const builds = await res.json();
    currentDownloadableBuilds = sortBuilds(builds);
    if(builds.length===0){ div.innerHTML="<div style='padding:10px;color:#888;'>No downloadable builds found.</div>"; return; }

    currentDownloadableBuilds.forEach(v=>{
      const item=document.createElement("div");
      const displayName = cleanVersionName(v);
      if(getBuildList().includes(v)){
        item.className="build-item downloadable downloaded";
        item.textContent=`${displayName} (Downloaded)`;
      } else {
        item.className="build-item downloadable";
        item.innerHTML = `<span><span class="download-icon">⬇</span>${displayName}</span>`;
        item.onclick = () => downloadBuild(v, item);
      }
      div.appendChild(item);
    });
  } catch(err){ div.innerHTML="<div style='padding:10px;color:#888;'>Failed to load builds.</div>"; console.error(err); }
}

// --- Download with progress ---
async function downloadBuild(version, itemElement){
  const progressBar = document.getElementById("progressBar");
  const progressFill = document.getElementById("progressFill");
  progressBar.style.display = "block";
  progressFill.style.width = "0%";
  try{
    const fileName = version.endsWith(".html") ? version : version + ".html";
    const res = await fetch(`${WORKER_URL}${encodeURIComponent(fileName)}`);
    if(!res.ok) throw new Error("Download failed");

    const reader = res.body.getReader();
    const contentLength = +res.headers.get('Content-Length') || 0;
    let receivedLength = 0;
    let chunks = [];

    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      chunks.push(value);
      receivedLength += value.byteLength;
      if(contentLength) progressFill.style.width = `${Math.floor(receivedLength / contentLength * 100)}%`;
    }

    const blob = new Blob(chunks, {type: "text/html"});
    const html = await blob.text();

    await saveBuild(version, html);
    let buildList = getBuildList();
    if(!buildList.includes(version)) buildList.push(version);
    saveBuildList(sortBuilds(buildList));

    loadLocalBuilds();
    fetchAvailableBuilds();
  } catch(err){ alert("Failed to download build."); console.error(err); }
  progressBar.style.display = "none";
}

// --- Play builds ---
async function playLocalBuild(version){
  const html = await getBuild(version);
  if(!html){ alert("Build not found locally."); return; }
  showIframe(html);
}

function showIframe(html){
  const container=document.getElementById("iframeContainer"); 
  const iframe=document.getElementById("gameIframe");
  iframe.srcdoc=html;
  container.classList.add("visible");
}

function closeIframe(){
  const container=document.getElementById("iframeContainer");
  container.querySelector("iframe").srcdoc="";
  container.classList.remove("visible");
}

document.getElementById("iframeContainer").addEventListener("click", e=>{
  if(e.target.id==="iframeContainer") closeIframe();
});

// --- Play latest build ---
function playLatestBuild(){
  const allBuilds = sortBuilds([...getBuildList(), ...currentDownloadableBuilds.filter(v=>!getBuildList().includes(v))]);
  if(allBuilds.length===0){ alert("No builds available."); return; }
  playBuild(allBuilds[0]);
}

function playBuild(version){
  if(getBuildList().includes(version)) playLocalBuild(version);
  else downloadBuild(version).then(()=>playLocalBuild(version));
}

// --- Init ---
window.onload = async ()=>{
  await openDB();
  loadLocalBuilds(); 
  fetchAvailableBuilds();
};
</script>
</body>
</html>
