<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Paked Launcher</title>

<style>
body, html {
  margin:0; padding:0;
  font-family: Arial, sans-serif;
  background:#1e1e2f;
  color:white;
  height:100%;
}
.top-bar {
  background:#2c2c3c;
  padding:10px 20px;
  display:flex;
  align-items:center;
  height:50px;
  position:relative;
  z-index:3;
}
.side-panel {
  position:absolute;
  top:50px; left:0;
  width:60px;
  height:calc(100% - 50px);
  background:#2a2a3a;
  transition:width .3s ease;
  overflow-y:auto;
  z-index:3;
}
.side-panel.expanded { width:300px; }
.toggle-btn {
  background:none;
  border:none;
  color:white;
  width:100%;
  padding:15px;
  cursor:pointer;
  font-size:16px;
  text-align:left;
}
.panel-section { padding:0 10px; margin-top:10px; }
.panel-section.hidden { display:none; }
.build-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  margin-bottom:5px;
  background:#3a3a4a;
  border-radius:5px;
}
.build-item.downloadable { cursor:pointer; color:#76c7c0; }
.build-item.downloaded { opacity:.5; cursor:default; }
.content {
  margin-left:60px;
  margin-top:50px;
  padding:20px;
}
.play-button {
  padding:20px 50px;
  font-size:24px;
  background:#28a745;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
.progress-bar {
  margin:20px auto;
  width:300px;
  height:20px;
  background:#444;
  border-radius:10px;
  overflow:hidden;
  display:none;
}
.progress-fill {
  height:100%;
  background:#76c7c0;
  width:0%;
}
.iframe-overlay {
  position:fixed;
  inset:0;
  background:black;
  z-index:9999;
  opacity:0;
  pointer-events:none;
  transition:opacity .3s ease;
}
.iframe-overlay.visible {
  opacity:1;
  pointer-events:all;
}
.iframe-overlay iframe {
  width:100%;
  height:100%;
  border:none;
}

/* Message box */
.message-box-overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  z-index:10000;
}
.message-box-overlay.visible {
  opacity:1;
  pointer-events:all;
}
.message-box {
  background:#2c2c3c;
  padding:20px;
  border-radius:10px;
  width:400px;
  max-width:90%;
  text-align:center;
}
.message-box-buttons {
  margin-top:20px;
  display:flex;
  justify-content:space-around;
}
.message-box button {
  padding:10px 15px;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
.primary { background:#28a745; color:white; }
.danger { background:#c0392b; color:white; }
</style>
</head>

<body>
<div class="top-bar"><h1>Paked Launcher</h1></div>

<div id="sidePanel" class="side-panel">
  <button class="toggle-btn" onclick="toggleSidePanel()">â˜°</button>

  <div id="localBuildsSection" class="panel-section hidden">
    <h3>Downloaded Builds</h3>
    <div id="localBuilds"></div>
  </div>

  <div id="downloadableBuildsSection" class="panel-section hidden">
    <h3>Downloadable Builds</h3>
    <div id="downloadableBuilds"></div>
  </div>
</div>

<div class="content">
  <button class="play-button" onclick="playLatestBuild()">Play Latest Build</button>
  <div class="progress-bar" id="progressBar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
</div>

<div id="iframeContainer" class="iframe-overlay">
  <iframe id="gameIframe"></iframe>
</div>

<div id="messageBoxOverlay" class="message-box-overlay">
  <div class="message-box">
    <h3 id="messageTitle"></h3>
    <p id="messageText"></p>
    <div class="message-box-buttons">
      <button class="primary" id="retryBtn">Try Again</button>
      <button id="onlineBtn">Run Online</button>
      <button class="danger" id="cancelBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://paked.proliverplays.workers.dev/";
let db;
let currentDownloadableBuilds = [];

/* ---------- VERSION SORT (FIXED) ---------- */
function parseVersion(str) {
  const match = str.match(/v\s*(\d+(?:\.\d+)*)/i);
  if (!match) return [0];
  return match[1].split('.').map(n => parseInt(n, 10));
}

function compareVersionsDesc(a, b) {
  const va = parseVersion(a);
  const vb = parseVersion(b);
  const len = Math.max(va.length, vb.length);
  for (let i = 0; i < len; i++) {
    const na = va[i] || 0;
    const nb = vb[i] || 0;
    if (na !== nb) return nb - na;
  }
  return 0;
}

/* ---------- STORAGE ---------- */
function getBuildList() {
  return JSON.parse(localStorage.getItem("pakedBuilds")) || [];
}
function saveBuildList(list) {
  localStorage.setItem("pakedBuilds", JSON.stringify(list));
}

/* ---------- UI ---------- */
function toggleSidePanel() {
  document.getElementById("sidePanel").classList.toggle("expanded");
}

/* ---------- FETCH BUILDS ---------- */
async function fetchAvailableBuilds() {
  const res = await fetch(WORKER_URL + "list");
  const builds = await res.json();

  currentDownloadableBuilds = [...builds].sort(compareVersionsDesc);

  const div = document.getElementById("downloadableBuilds");
  div.innerHTML = "";

  currentDownloadableBuilds.forEach(v => {
    const item = document.createElement("div");
    item.className = "build-item downloadable";
    item.textContent = v.replace(/\.html$/i, "");
    item.onclick = () => playBuild(v);
    div.appendChild(item);
  });

  document.getElementById("downloadableBuildsSection").classList.remove("hidden");
}

/* ---------- PLAY ---------- */
function playLatestBuild() {
  if (currentDownloadableBuilds.length === 0) {
    alert("No builds available");
    return;
  }
  playBuild(currentDownloadableBuilds[0]); // newest
}

function playBuild(version) {
  runOnlineVersion(version);
}

/* ---------- ONLINE RUN ---------- */
function runOnlineVersion(version) {
  const iframe = document.getElementById("gameIframe");
  iframe.src = WORKER_URL + encodeURIComponent(version);
  iframe.removeAttribute("srcdoc");
  document.getElementById("iframeContainer").classList.add("visible");
}

/* ---------- INIT ---------- */
window.onload = fetchAvailableBuilds;
</script>
</body>
</html>
